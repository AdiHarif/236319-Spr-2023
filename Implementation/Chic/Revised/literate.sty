
\newcounter{segment}
\setcounter{segment}{0}
\newread  \tempFile     % A temporary reading stream
\newwrite \codeFile     % A stream to save the code fragment 

%\immediate \openout \codeFile=\jobname.cc

\lstnewenvironment{code}[1][\relax]{\lstset{#1}}{}

\definecolor{eclipse-purple}{rgb}{0.50,0.00,0.33} % Keyowrds
\definecolor{eclipse-blue}{rgb}{0.16,0.00,1.00} % Doc 
\definecolor{eclipse-green}{rgb}{0.25,0.50,0.37} % Comments
\definecolor{eclipse-red}{rgb}{0.6,0,0} % for strings

\definecolor{clr-background}{RGB}{255,255,255}
\definecolor{clr-text}{RGB}{0,0,0}
\definecolor{clr-string}{RGB}{163,21,21}
\definecolor{clr-namespace}{RGB}{0,0,0}
\definecolor{clr-preprocessor}{RGB}{128,128,128}
\definecolor{clr-keyword}{RGB}{0,0,255}
\definecolor{clr-type}{RGB}{43,145,175}
\definecolor{clr-variable}{RGB}{0,0,0}
\definecolor{clr-constant}{RGB}{111,0,138} % macro color
\definecolor{clr-comment}{RGB}{0,128,0}

\def\Expect{\hfill Expecting}
\lstset{%
    language=C++,
    morekeywords={Constants, Provides, Representation, Short, Let, Long, let},
  	basicstyle=\color{black}, % any text
   	commentstyle=\color{eclipse-green},
	stringstyle=\color{eclipse-red},
	identifierstyle=\color{clr-variable}\ttfamily, % just about anything that isn't a directive, comment, string or known type
	directivestyle=\color{blue}\itshape, % preprocessor commands
	% listings doesn't differentiate between types and keywords (e.g. int vs return)
	% use the user types color
	keywordstyle=\color{clr-type}\rmfamily,
	keywordstyle={[2]\color{blue!50!black}}, % you'll need to define these or use a custom language
    commentstyle=\itshape,
    keywordstyle=\bfseries\color{eclipse-purple},
    stringstyle=\ttfamily,
    breaklines=true,
    columns={fullflexible},
    texcl=true,
    fontadjust,
    escapechar=`,
    mathescape,
    extendedchars=false,
    showstringspaces=true,
    escapeinside={/*}{*/},
    escapebegin={\works},
 literate=
    {*}{$\times$}{1}
    {!}{$\neg$}{1}
    {*this}{\bfseries self}{1}
    {==}{$=$}{1}
    {Expect}{\Expect}0
    {<=}{$\le$}{1}
    {>=}{$\ge$}{1}
    {!=}{$\ne$}{1}
    {&&}{$\wedge$}{1}
    {||}{$\vee$}{1}
    %{=}{$\leftarrow$}{1}
    {1<<0}{$2^{0}$}{3}
    {1<<1}{$2^{1}$}{3}
    {1<<2}{$2^{2}$}{3}
    {1<<3}{$2^{3}$}{3}
    {1<<4}{$2^{4}$}{3}
    {1<<5}{$2^{5}$}{3}
    {1<<6}{$2^{6}$}{3}
    {1<<7}{$2^{7}$}{3}
    {1<<8}{$2^{8}$}{3}
    {1<<9}{$2^{9}$}{3}
    {1<<10}{$2^{10}$}{3}
    {1<<11}{$2^{11}$}{3}
    {1<<12}{$2^{12}$}{3}
    {1<<13}{$2^{13}$}{3}
    {1<<14}{$2^{14}$}{3}
    {1<<15}{$2^{15}$}{3}
    {1<<16}{$2^{16}$}{3}
    {1<<17}{$2^{17}$}{3}
    {1a<<$H_x$}{$2^{H_x}$}{3}
}

\begingroup
\catcode`@=\active
\gdef\works{%    note the global \gdef
  \catcode`@=\active
  \def@##1@{%
        \noindent\textbf{\refstepcounter{segment}\arabic{segment}.~##1.}%
  }%
}%
\endgroup
